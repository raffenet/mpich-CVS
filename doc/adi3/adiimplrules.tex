\subsection{Steps Needed in Implementing a Device}
\begin{enumerate}
\item \code{mpiexec}.  Define how \mpich\ creates the correct
\code{mpiexec}.  There must be an \code{mpiexec} target in the
device's \file{Makefile}.

\item Installation.  Define how \mpich\ gets the proper device-specific files
  installed; e.g., if the device uses the multi-purpose demon
  (\code{mpd}), ensure that the \code{mpd} is installed.  Provide an
  \code{install} target in the device's \file{Makefile}.  For example,
  in the \file{Makefile.sm}, use the line
\begin{verbatim}
install_BIN = mpd
\end{verbatim}
to install the program \code{mpd} into the \file{bin} directory.

\item Device-specific documentation, such as environment variables and
  command-line arguments used only by a particular device.  Place this
  information into the file \file{devdoc.txt}.  The \mpich\
  documentation generators will look for this file.

\item Testing codes for device-specific functions.  Place these
in a \file{test} subdirectory of the device. These tests 
should be performed through a \code{test} target in the device's
\file{Makefile}. 

\item Include files.  Any include files that are needed by
\file{mpiimpl.h} (used to build the implementation of the MPI
routines) should be \emph{copied} into \file{mpich/src/include} as
part of the device's configure step.  Provide the files
\file{mpidpre.h} and \file{mpidpost.h}.  The implementation of all MPI
routines include files in this order:
\begin{description}
\item[mpi.h]The standard \file{mpi.h} that all MPI users include
\item[mpidpre.h]Any definitions needed \emph{before} the provided
definitions of the contents of the internal structures.  This can
included definitions that override parts of \file{mpiimpl.h}
\item[contents of mpiimpl.h]The bulk of the internal definitions.
This also includes information on the timers.
\item[mpidpost.h]Any definitions needed by the device after the rest
of the definitions in \file{mpiimpl.h}.  In many cases, this file may
be empty.
\end{description}
All of these are included by the file \file{mpiimpl.h}.
\end{enumerate}

\subsection{Directory Structure}
\label{sec:adi3-dirs}
A device should be placed in a subdirectory of \file{mpich/src/mpid/};
for example, \file{mpich/src/mpid/mm} is the multi-method ADI
delivered with \mpich.  The directory name is the same as the device
name specified to the \mpich\ \code{configure} with the
\code{--with-device} option.

\subsection{Device Configuration and Setup}
\label{sec:adi3-setup}
Each device must have a \code{configure} script.  This will be run by
the \mpich\ \code{configure} as part of the top-level configuration.
Any other commands that a device needs for setup should be run using
the \code{AC_OUTPUT_COMMANDS} \code{autoconf} macro.  Autoconf version
2.13 or later, but before 2.50, should be used; we recommend using the
macros defined in 
\file{mpich/confdb/aclocal.m4}, as they include fixes to
\code{autoconf}\footnote{There are serious bugs in the
\texttt{AC_CHECK_HEADER} macro that are still present in
\texttt{autoconf} 2.52.}
Do not modify the \mpich\ \code{configure} to support a device.

There must be a \code{echomaxprocname} target in the \file{Makefile}
in the device's directory.  This should look something like
\begin{verbatim}
echomaxprocname:
       @echo 128
\end{verbatim}
This value will be used as the value for
\code{MPI_MAX_PROCESSOR_NAME}, and must be an integer value.

