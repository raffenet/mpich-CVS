
##### User configurable options #####

MAKE                 = @MAKE@

CPP                  = @CPP@
MPI_CC               = @MPI_CC@
MPI_F77              = @MPI_F77@
MPI_CLINKER          = $(MPI_CC)
MPI_FLINKER          = $(MPI_F77)
#
DEBUG_LIBS           = @DEBUG_LIBS@
MPI_INC              = @MPI_INC@
MPI_LIBS             = @MPI_LIBS@
CFLAGS               = @CFLAGS@
FFLAGS               = @FFLAGS@
MPE_INCDIR           = @includebuild_dir@
MPE_LIBDIR           = @libbuild_dir@
PROF_LIBS            = -L$(MPE_LIBDIR) @PROF_LIBS@ $(MPI_LIBS)
LOG_LIBS             = -L$(MPE_LIBDIR) @LOG_LIBS@ $(MPI_LIBS)
TRACE_LIBS           = -L$(MPE_LIBDIR) @TRACE_LIBS@ $(MPI_LIBS)
F2CMPI_LIBS          = @F2CMPI_LIBS@
PROF_FLIBS           = @FLIB_PATH_LEADER@$(MPE_LIBDIR) \
                       $(F2CMPI_LIBS) @PROF_LIBS@ \
                       $(MPI_LIBS)
LOG_FLIBS            = @FLIB_PATH_LEADER@$(MPE_LIBDIR) \
                       $(F2CMPI_LIBS) @LOG_LIBS@ \
                       $(MPI_LIBS)
#
C_INCS               = -I$(MPE_INCDIR) $(MPI_INC)
F_INCS               = @FINC_PATH_LEADER@$(MPE_INCDIR) $(MPI_INC)
LDFLAGS              = @LDFLAGS@
MPE_BUILD_FORTRAN2C  = @MPE_BUILD_FORTRAN2C@
RM                   = @RM@

### End User configurable options ###

@VPATH@

srcdir        = @srcdir@

CC_FLAGS      = $(CFLAGS) $(C_INCS) $(MPE_COPTS)
FC_FLAGS      = $(FFLAGS) $(F_INCS) $(MPE_FOPTS)
CC_LDFLAGS    = $(LDFLAGS) $(CFLAGS) $(MPE_LDOPTS)
FC_LDFLAGS    = $(LDFLAGS) $(FFLAGS) $(MPE_LDOPTS)
EXECS         = cpilog@EXEEXT@ cpilog_pack@EXEEXT@ srtest@EXEEXT@

.SUFFIXES: .c .f .n@OBJEXT@ .@OBJEXT@ @EXEEXT@

.c.@OBJEXT@:
	$(MPI_CC) $(CC_FLAGS) -c $<

.f.@OBJEXT@:
	$(MPI_F77) $(FC_FLAGS) -c $<

.c.n@OBJEXT@:
	$(MPI_CC) -DNO_MPI_LOGGING $(CC_FLAGS) -c $<
	mv -f $*.@OBJEXT@ $*.n@OBJEXT@

.F.@OBJEXT@:
	rm -f mpe2tmp.f mpe2tmp.@OBJEXT@
	$(CPP) $< > mpe2tmp.f && \
	$(MPI_F77) $(FC_FLAGS) -c mpe2tmp.f
	mv -f mpe2tmp.@OBJEXT@ $*.@OBJEXT@

.F.n@OBJEXT@:
	rm -f mpe2tmp.f mpe2tmp.@OBJEXT@
	$(CPP) -DNO_MPI_LOGGING $< > mpe2tmp.f && \
	$(MPI_F77) $(FC_FLAGS) -c mpe2tmp.f
	mv -f mpe2tmp.@OBJEXT@ $*.n@OBJEXT@

default: $(EXECS)
	@-if [ "$(MPE_BUILD_FORTRAN2C)" = "yes" ] ; then \
	     $(MAKE) fpilog@EXEEXT@ ; \
	     $(MAKE) fpilog_pack@EXEEXT@ ; \
	 fi

cpi_trace@EXEEXT@: cpi.@OBJEXT@
	$(MPI_CLINKER) $(CC_LDFLAGS) -o $@ $? $(TRACE_LIBS) $(DEBUG_LIBS) -lm

cpi_log@EXEEXT@: cpi.@OBJEXT@
	$(MPI_CLINKER) $(CC_LDFLAGS) -o $@ $? $(LOG_LIBS) $(DEBUG_LIBS) -lm

cpilog@EXEEXT@: cpilog.@OBJEXT@
	$(MPI_CLINKER) $(CC_LDFLAGS)  -o $@ $? $(LOG_LIBS) $(DEBUG_LIBS) -lm 

cpilog_pack@EXEEXT@: cpilog_pack.@OBJEXT@
	$(MPI_CLINKER) $(CC_LDFLAGS)  -o $@ $? $(LOG_LIBS) $(DEBUG_LIBS) -lm 

ncpilog@EXEEXT@: cpilog.n@OBJEXT@
	$(MPI_CLINKER) $(CC_LDFLAGS)  -o $@ $? $(PROF_LIBS) $(DEBUG_LIBS) -lm 

ncpilog_pack@EXEEXT@: cpilog_pack.n@OBJEXT@
	$(MPI_CLINKER) $(CC_LDFLAGS)  -o $@ $? $(PROF_LIBS) $(DEBUG_LIBS) -lm 

fpilog@EXEEXT@: fpilog.@OBJEXT@
	$(MPI_FLINKER) $(FC_LDFLAGS) -o $@ $? $(LOG_FLIBS) $(DEBUG_LIBS) -lm

fpilog_pack@EXEEXT@: fpilog_pack.@OBJEXT@
	$(MPI_FLINKER) $(FC_LDFLAGS) -o $@ $? $(LOG_FLIBS) $(DEBUG_LIBS) -lm

nfpilog_pack@EXEEXT@: fpilog_pack.n@OBJEXT@
	$(MPI_FLINKER) $(FC_LDFLAGS) -o $@ $? $(PROF_FLIBS) $(DEBUG_LIBS) -lm

srtest@EXEEXT@: srtest.@OBJEXT@
	$(MPI_CLINKER) $(CC_LDFLAGS)  -o $@ $? $(LOG_LIBS) $(DEBUG_LIBS) -lm

iotest@EXEEXT@: iotest.@OBJEXT@
	$(MPI_CLINKER) $(CC_LDFLAGS)  -o $@ $? $(LOG_LIBS) $(DEBUG_LIBS) -lm

linktest: linktest_C

linktest_C: 
	@-echo ; \
	echo "** Testing if C program can be linked with MPI tracing library..." ; \
	$(RM) -f cpi_trace@EXEEXT@ ; \
	$(MAKE) cpi_trace@EXEEXT@ ; \
	if test -x cpi_trace@EXEEXT@ ; then \
	    echo "** C program can be linked with MPI tracing library." ; \
	    $(RM) -f cpi_trace@EXEEXT@ ; \
	else \
	    echo "** C program CANNOT be linked with MPI tracing library." ; \
	fi 
	@-echo ; \
	echo "** Testing if C program can be linked with MPI logging library..." ; \
	$(RM) -f cpi_log@EXEEXT@ ; \
	$(MAKE) cpi_log@EXEEXT@ ; \
	if test -x cpi_log@EXEEXT@ ; then \
	    echo "** C program can be linked with MPI logging library." ; \
	    $(RM) -f cpi_log@EXEEXT@ ; \
	else \
	    echo "** C program CANNOT be linked with MPI logging library." ; \
	fi 
	@-echo ; \
	echo "** Testing if C program can do both MPI and manual logging together..." ; \
	$(RM) -f cpilog@EXEEXT@ ; \
	$(MAKE) cpilog@EXEEXT@ ; \
	if test -x cpilog@EXEEXT@ ; then \
	    echo "** C program can do both MPI and manual logging together." ; \
	    $(RM) -f cpilog@EXEEXT@ ; \
	else \
	    echo "** C program CANNOT do both MPI and manual logging together." ; \
	fi ; \
	echo
	@-$(MAKE) clean

linktest_F77: 
	@-if [ "$(MPE_BUILD_FORTRAN2C)" = "yes" ] ; then \
	    echo ; \
	    echo "** Testing if Fortran77 program can do both MPI and manual logging together..." ; \
	    $(RM) -f fpilog@EXEEXT@ ; \
	    $(MAKE) fpilog@EXEEXT@ ; \
	    if test -x fpilog@EXEEXT@ ; then \
	        echo "** Fortran77 program can do both MPI and manual logging together." ; \
	        $(RM) -f fpilog@EXEEXT@ ; \
	    else \
	        echo "** Fortran77 program CANNOT do both MPI and manual logging together." ; \
	    fi ; \
	    echo ; \
	    $(MAKE) clean ; \
	  fi

clean:
	@-$(RM) -f work.pc work.pcl
	@-$(RM) -f *.@OBJEXT@ *~ PI* $(EXECS)
	@-$(RM) -f cpi_log@EXEEXT@ cpi_trace@EXEEXT@ cpilog@EXEEXT@ fpilog@EXEEXT@ fpilog_pack@EXEEXT@ srtest@EXEEXT@
	@-$(RM) -f *.clog2 *.slog2

distclean: clean
	@-$(RM) -f Makefile
