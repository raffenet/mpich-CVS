AC_INIT(configure.in)

dnl
dnl Set the directory that contains support scripts such as install-sh and
dnl config.guess
dnl
AC_CONFIG_AUX_DIR(../../../confdb)

dnl
dnl Definitions will be placed in this file rather than in the DEFS variable
dnl
AC_CONFIG_HEADER(../../include/mpid_ch3_conf.h)


echo "RUNNING CONFIGURE FOR DEVICE CH3"
echo "PASSED: $*"

AC_ARG_WITH(device,
[--with-device=name - Specify the communication device for MPICH.],,
with_device=default)

dnl This test is complicated by the fact that top_srcdir is not set until
dnl the very end of configure.  Instead, we get it ourselves
if test -z "$top_srcdir" ; then
    use_top_srcdir=$srcdir   
else
    use_top_srcdir=$top_srcdir
fi
if test -z "$master_top_srcdir" ; then 
    master_top_srcdir=$use_top_srcdir
fi
AC_SUBST(master_top_srcdir)
export master_top_srcdir
dnl
dnl Extract the device and channel name from the --with-device argument
if test "$with_device" = "default" ; then
DEVICE=ch3
CHANNEL=tcp
AC_SUBST(DEVICE)
AC_SUBST(CHANNEL)
else
DEVICE=`echo $with_device | sed -e 's/:.*//g'`
AC_SUBST(DEVICE)
changequote(<<,>>)
CHANNEL=`echo $with_device | sed -e 's/[^:]*://g'`
changequote([,])
AC_SUBST(CHANNEL)
fi

if test ! -d $srcdir/channels/$CHANNEL ; then
    AC_MSG_ERROR([Channel $CHANNEL is unknown])
elif test ! -x $srcdir/channels/$CHANNEL/configure ; then
    AC_MSG_ERROR([Channel $CHANNEL has no configure])
fi

dnl AC_PROG_MAKE_SET
PAC_PROG_MAKE

AC_SUBST(AR)
AC_SUBST(RANLIB)
AC_SUBST(MPILIBNAME)
AC_SUBST(CC)
AC_SUBST(CFLAGS)

AC_CONFIG_SUBDIRS(channels/$CHANNEL)

AC_OUTPUT_COMMANDS(cp $srcdir/include/mpidpre.h ../../include/)
AC_OUTPUT_COMMANDS(cp $srcdir/include/mpidpost.h ../../include/)
AC_OUTPUT(Makefile src/Makefile channels/Makefile)
