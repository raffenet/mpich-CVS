# Makefile.in for mpd2

@SET_MAKE@
prefix    = @prefix@
exec_prefix = @exec_prefix@
bindir    = @bindir@
srcdir	  = @srcdir@
SHELL	  = @SHELL@
CC	  = @CC@
INCLUDES  = -I. -I${srcdir}
CPPFLAGS  = @CPPFLAGS@
CLINKER	  = @CLINKER@
COPTIONS  = @COPTIONS@
LDFLAGS	  = @LDFLAGS@
LIBS	  = @LIBS@ 
PYTHON    = @PYTHON@
INSTALL   = @INSTALL@

C_COMPILE = ${CC} ${INCLUDES} ${CFLAGS} ${COPTIONS}
C_LINK	  = ${CLINKER} ${CFLAGS} ${COPTIONS} ${LDFLAGS}

VPATH     = .:@srcdir@

PROGRAMS  = mpdroot
EXAMPLES  = sigcatcher infloop

SOURCES   = ${mpdroot_SOURCES} ${example_SOURCES}
OBJECTS   = ${mpdroot_OBJECTS} ${example_OBJECTS}
HEADERS   = mpdconf.h mpdroot.h

CMDS_ROOT     =  mpiexec mpdrun mpdtrace mpdringtest mpdlistjobs mpdkilljob mpdsigjob
CMDS_NO_ROOT  =  mpdexit mpdallexit mpdcleanup mpdhelp mpdboot mpd
PYTHON_SOURCE =  mpiexec.py mpdrun.py mpdtrace.py mpdringtest.py mpdlistjobs.py mpdkilljob.py \
                 mpdsigjob.py mpdexit.py mpdallexit.py mpdcleanup.py mpdhelp.py mpdboot.py \
		 mpd.py mpdman.py mpdlib.py

mpdroot_SOURCES  = mpdroot.c
example_SOURCES	 = sigcatcher.c infloop.c

mpdroot_OBJECTS	= ${mpdroot_SOURCES:.c=.o}
example_OBJECTS	= ${example_SOURCES:.c=.o}


all: Makefile ${PROGRAMS}
	chmod 755 mpdroot
	for cmd in ${CMDS_NO_ROOT} ; do \
	    sed -e 's/\/usr\/bin\/env python.*/\/usr\/bin\/env ${PYTHON}/' ${srcdir}/$$cmd.py > $$cmd ; \
	    chmod 755 $$cmd ;\
	done
	for cmd in ${CMDS_ROOT}; do \
	    sed -e 's/\/usr\/bin\/env python.*/\/usr\/bin\/env ${PYTHON}/' ${srcdir}/$$cmd.py > $$cmd\_for_mpdroot.py ; \
	    chmod 755 $$cmd\_for_mpdroot.py ;\
	    @LN_S@ -f mpdroot $$cmd ;\
	done
	cp mpigdb.sh mpigdb
	chmod 755 mpigdb
	chmod 755 mpdgdbdrv.py
	chmod 755 mpdrun.py
	@LN_S@ -f mpdrun mpirun
	@LN_S@ -f mpdrun.py mpirun.py


.SUFFIXES:
.SUFFIXES: .o .dep .c 

etags:  ${HEADERS} ${SOURCES}
	etags ${HEADERS} ${SOURCES}

mpdroot: ${mpdroot_OBJECTS}
	$(C_LINK) -o mpdroot ${mpdroot_OBJECTS} $(LIBS)

mpdroot.o: ${srcdir}/mpdroot.c ${srcdir}/mpdroot.h mpdconf.h
	${C_COMPILE} -c $< 

# The following lines provide the right libraries for all example programs
.c:
	${C_LINK} -o $* $*.c $(LIBS)
.o:     
	$(C_LINK) -o $* $*.o $(LIBS)

clean: 
	@-/bin/rm -f *.o *.dep *~ ${EXAMPLES} core*

# echo "some of the following might be executables you want to remove"
# ls -l | grep rwx
distclean: clean
	/bin/rm -f Makefile mpdconf.h ${PROGRAMS} ${CMDS_NO_ROOT}
	/bin/rm -f mpirun.py mpirun mpigdb config.status config.cache config.log
	for cmd in ${CMDS_ROOT}; do \
	    /bin/rm -f $$cmd\_for_mpdroot.py ; \
	    /bin/rm -f $$cmd ; \
	done


maintainer-clean: distclean
	/bin/rm -f configure mpdconf.h.in
	/bin/rm -rf autom4te.cache

configure: configure.in
	./makeconfigure

Makefile: ${srcdir}/Makefile.in config.status
	./config.status

.c.o:	
	${C_COMPILE} -c $<

install: all
	if [ ! -d ${bindir} ] ; then \
	    echo "mkdir -p ${bindir} " ;\
	    mkdir -p ${bindir} ;\
	fi   
	if [ "`whoami`" = "root" ] ; then \
	    ${INSTALL} -m 4755 mpdroot ${bindir}/mpdroot ;\
        else \
	    ${INSTALL} -m  755 mpdroot ${bindir}/mpdroot ;\
	fi
	for cmd in ${CMDS_NO_ROOT} ; do \
	    ${INSTALL} -m 755 $$cmd.py ${bindir}/$$cmd.py ; \
	    ${INSTALL} -m 755 $$cmd.py ${bindir}/$$cmd ; \
	done
	for cmd in ${CMDS_ROOT}; do \
	    ${INSTALL} -m 755 $$cmd.py ${bindir}/$$cmd.py; \
	    ${INSTALL} -m 755 $$cmd\_for_mpdroot.py ${bindir}/$$cmd\_for_mpdroot.py; \
	    ( cd ${bindir} && @LN_S@ -f mpdroot $$cmd ; ) \
	done
	${INSTALL} -m 755 ${srcdir}/mpigdb.sh ${bindir}/mpigdb
	${INSTALL} -m 755 ${srcdir}/mpdgdbdrv.py ${bindir}/mpdgdbdrv.py
	${INSTALL} -m 755 ${srcdir}/mpdman.py ${bindir}/mpdman.py
	${INSTALL} -m 755 ${srcdir}/mpdlib.py ${bindir}/mpdlib.py
	( rm -f ${bindir}/mpirun >/dev/null 2>&1 || exit 0 )
	cd ${bindir} && @LN_S@ -f mpdrun mpirun
	cd ${bindir} && @LN_S@ -f mpdrun.py mpirun.py


mpich2-build-install: mpich2-mpdroot install
	if [ "`whoami`" = "root" ] ; then \
            ${INSTALL} -m 4755 mpich2-mpdroot ${bindir}/mpdroot ;\
	else \
            ${INSTALL} -m  755 mpich2-mpdroot ${bindir}/mpdroot ;\
	fi
	/bin/rm -f mpich2-mpdroot

mpich2-build-uninstall:
	/bin/rm -f ${bindir}/mpdroot

mpich2-mpdroot: mpich2-mpdroot.o
	$(C_LINK) -o mpich2-mpdroot mpich2-mpdroot.o $(LIBS)
	/bin/rm -f mpich2-mpdroot.o

mpich2-mpdroot.o: ${srcdir}/mpdroot.c ${srcdir}/mpdroot.h mpdconf.h
	${INSTALL} -m 644 ${srcdir}/mpdroot.c mpich2-mpdroot.c
	${C_COMPILE} -c mpich2-mpdroot.c
	/bin/rm -f mpich2-mpdroot.c

