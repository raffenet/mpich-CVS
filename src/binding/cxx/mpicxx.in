#! /bin/sh
#
# mpicxx
# Simple script to compile and/or link MPI programs.
# This script knows the default flags and libraries, and can handle
# alternative C++ compilers and the associated flags and libraries.
# The important terms are:
#    includedir, libdir - Directories containing an *installed* mpich2
#    prefix, execprefix - Often used to define includedir and libdir
#    CXX                - C compiler
#    MPI_CXXFLAGS       - Any special flags needed to compile 
#    MPI_LDFLAGS        - Any special flags needed to link
#    MPILIBNAME         - Name of the MPI library
#    MPI_OTHERLIBS      - Other libraries needed in order to link 
#    
# We assume that (a) the C++ compiler can both compile and link programs
# We use MPI_xxx so that the user may continue to use CXXFLAGS, LIBS, etc
# to modify the behavior of the compiler and linker.
#
# Handling of command-line options:
#   This is a little tricky because some options may contain blanks.
#
# Special issues with shared libraries - todo
#
#
# Directory locations: Fixed for any MPI implementation
prefix=@prefix@
exec_prefix=@exec_prefix@
sysconfdir=@sysconfdir@
includedir=@includedir@
libdir=@libdir@
#
# Default settings for compiler, flags, and libraries
CXX="@CXX@"
MPI_CXXFLAGS="@MPI_CXXFLAGS@"
MPI_LDFLAGS="@MPI_LDFLAGS@"
MPILIBNAME="@MPILIBNAME@"
MPI_OTHERLIBS="@LIBS@"
#
mpilibs=-l$MPILIBNAME
#
# Concatenate the user flags with the ones needed by MPI
# For now, the HAVE_MPI_CXX flag is used to control the inclusion of 
# mpicxx.h in the mpi.h file.
CXXFLAGS="$CFLAGS $MPI_CXXFLAGS -DHAVE_MPI_CXX"
LDFLAGS="$LDFLAGS $MPI_LDFLAGS"
#
# Look through the arguments for arguments that indicate compile only.
# If these are *not* found, add the library options
linking=yes
for arg in "$@" ; do
    case $arg in 
    -c|-S|-E|-M)
    linking=no
    ;;
    esac
done
#
# A temporary statement to invoke the compiler
# Place the -L before any args incase there are any mpi libraries in there.
# Eventually, we'll want to move this after any non-MPI implementation 
# libraries
if [ "$linking" = yes ] ; then
    $CXX $CXXFLAGS $LDFLAGS -I$includedir -L$libdir "$@" $mpilibs $MPI_OTHERLIBS
    rc=$?
else
    $CXX $CXXFLAGS -I$includedir "$@"
    rc=$?
fi

exit $rc

